name: deploy-integration

on:
  workflow_run:
    workflows: ["publish-ghcr"]
    types: [completed]

permissions:
  contents: read
  packages: read

jobs:
  deploy_and_test:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start stack using GHCR image
        env:
          PYTHON_IMAGE: ghcr.io/${{ github.repository }}:sha-${{ github.event.workflow_run.head_sha }}
          POSTGRES_DB: students
          POSTGRES_USER: students
          POSTGRES_PASSWORD: students
          REDIS_HOST: redis
        run: |
          PYTHON_IMAGE="ghcr.io/${GITHUB_REPOSITORY,,}:sha-${{ github.event.workflow_run.head_sha }}"
          export PYTHON_IMAGE
          docker compose up -d

      - name: Verify Nginx proxy to API
        run: |
          for i in {1..15}; do
            if curl -fsS http://localhost:8080/api/ >/dev/null; then
              echo "Proxy check passed"
              exit 0
            fi
            sleep 2
          done
          echo "Proxy check failed"
          docker compose ps
          docker compose logs --no-color
          exit 1

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v